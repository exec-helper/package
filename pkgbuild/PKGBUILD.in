# Maintainer: Bart Verhagen <barrie.verhagen@gmail.com>
pkgname='@PACKAGE@'
pkgbase='@PACKAGE@'
pkgver=@VERSION@
pkgrel=@PKGREL@
epoch=@EPOCH@
pkgdesc="How To Get Coffee In Peace: a shell meta-wrapper"
arch=('i686' 'x86_64')
url="https://github.com/exec-helper/source"
license=('BSD')
groups=()
depends=()
makedepends=(meson cmake boost ninja python-sphinx python-sphinx_rtd_theme pkg-config microsoft-gsl lsb-release yaml-cpp boost-libs lua53)
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=@CHANGELOG@
source=("@PACKAGE@::$url/archive/@GIT_REF@.tar.gz")
noextract=()
validpgpkeys=()

_source_dir='source-@GIT_REF@'
_build_dir='build'

pkgver() {
    printf "%s" $pkgver
}

build() {
    _system_description=$(lsb_release --description --short | sed 's/"//g')
    _source_version=@VERSION@
    _release_version="($_system_description) $_source_version"
    _copyright="Copyright (c) $(date +'%Y') Bart Verhagen"

    arch-meson "$_source_dir" "$_build_dir" --unity on -D "usage-documentation=true" -D "api-documentation=false" -D "plugins-prefix=/usr/share/exec-helper/plugins" -D "test=false" -D "use-system-yaml-cpp=enabled" -D "use-system-lua=enabled" -D "use-system-catch2=enabled" -D "use-system-rapidcheck=enabled" -D "use-static-boost=true" -D "version=$_release_version" -D "copyright=$_copyright"
    meson compile -C "$_build_dir"
}

check() {
    _install_dir="$pkgdir/usr/"
    "$_build_dir/src/applications/exec-helper" --help | grep --silent 'Usage'
    "$_build_dir/src/applications/exec-helper" --version | grep --silent 'exec-helper'
	"$_build_dir/src/applications/exec-helper" --list-plugins "--additional-search-path=$_source_dir/src/plugins/src/scripts" | grep --silent 'make.lua'
}

package() {
    DESTDIR="$pkgdir" meson install -C "$_build_dir" --no-rebuild
}

md5sums=('SKIP')
