# Maintainer: Bart Verhagen <barrie.verhagen@gmail.com>
pkgname='@PACKAGE@'
pkgbase='@PACKAGE@'
pkgver=@VERSION@
pkgrel=@PKGREL@
epoch=@EPOCH@
pkgdesc="How To Get Coffee In Peace: a shell meta-wrapper"
arch=('i686' 'x86_64')
url="https://github.com/exec-helper/source"
license=('GPL3')
groups=()
depends=(yaml-cpp boost-libs lua)
makedepends=(meson cmake boost python-sphinx python-sphinx_rtd_theme git pkg-config microsoft-gsl lsb-release)
checkdepends=(catch2 rapidcheck)
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=@CHANGELOG@
source=('@PACKAGE@::git+https://github.com/exec-helper/source.git#@GIT_REF@')
noextract=()
validpgpkeys=()

_build_dir='build'

pkgver() {
    printf "%s" $pkgver
}

build() {
    _system_description=$(lsb_release --description --short | sed 's/"//g')
    _source_version=@VERSION@
    _release_version="($_system_description) $_source_version"
    _copyright="Copyright (c) $(date +'%Y') Bart Verhagen"

    _git_dir="@PACKAGE@"
    _exec_helper_build_targets=('exec-helper' 'docs-man')
    _exec_helper_docs_build_targets=('docs-html')

	meson setup --buildtype debugoptimized --prefix "$pkgdir/usr/" -D "usage-documentation=true" -D "api-documentation=false" -D "plugins-prefix=/usr/share/exec-helper/plugins" -D "test=false" -D "version=$_release_version" -D "copyright=$_copyright" -D "use-system-yaml=enabled" -D "use-system-gsl=enabled" -D "use-system-lua=enabled" "$_build_dir" "$_git_dir"
	meson compile -C "$_build_dir"
}

check() {
    _install_dir="$pkgdir/usr/"
    $_build_dir/src/applications/exec-helper --help 2>/dev/null | grep --silent 'Usage'
    $_build_dir/src/applications/exec-helper --version 2>/dev/null | grep --silent 'exec-helper'
	$_build_dir/src/applications/exec-helper --list-plugins "--additional-search-path=$_git_dir/src/plugins/src/scripts" 2>/dev/null | grep --silent 'make.lua'
}

package() {
	meson install -C "$_build_dir" --no-rebuild
}

md5sums=('SKIP')
