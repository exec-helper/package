PROJECT_NAME:=exec-helper

SOURCE_DIR:=../$(PROJECT_NAME)
GIT_VERSION:=$(shell git -C $(SOURCE_DIR) describe --long "--match=*.*.*" 2>/dev/null || git -C $(SOURCE_DIR) log -n1 --pretty=format:g%h)
SOURCE_VERSION:=$(shell echo $(GIT_VERSION) | sed -E 's@([^-]*)-.*$$@\1@g')
GIT_REVISION:=$(shell echo $(GIT_VERSION) | sed -E 's@[^-]*-([^-])*-.*$$@\1@g')
RPM_REVISION:=$(shell echo $$(($(GIT_REVISION)+1)))
GIT_COMMIT:=$(shell git -C $(SOURCE_DIR) log --format=%h -n1)
ARCHITECTURE:=$(shell $(CC) -dumpmachine | cut -d'-' -f1)

YEAR:=$(shell date +'%Y')

VERSION:=$(SOURCE_VERSION)-$(DEBIAN_REVISION)~git$(GIT_COMMIT)

BUILD_DIR:=build
PACKAGE_DIR:=package

SRPM_PACKAGE=$(HOME)/rpmbuild/SRPMS/$(PROJECT_NAME)-$(VERSION)-$(RPM_REVISION).src.rpm
RPM_PACKAGE=$(HOME)/rpmbuild/RPMS/$(ARCHITECTURE)/$(PROJECT_NAME)-$(VERSION)-$(RPM_REVISION).$(ARCHITECTURE).rpm
SOURCE_ARCHIVE:=$(HOME)/rpmbuild/SOURCES/$(PROJECT_NAME)-$(SOURCE_VERSION).tar.gz
SOURCE_FILES:=meson.build

PREPARE_MAKEFILE:=prepare.Makefile
SOURCE_MAKEFILE:=source.Makefile
BINARY_MAKEFILE:=binary.Makefile

all: prepare

prepare:
	$(MAKE) --makefile=$(PREPARE_MAKEFILE) PROJECT_NAME=$(PROJECT_NAME) BUILD_DIR=$(BUILD_DIR)/prepare SOURCE_DIR=$(SOURCE_DIR) SOURCE_FILES=$(SOURCE_FILES) VERSION=$(VERSION) SOURCE_ARCHIVE=$(SOURCE_ARCHIVE) "SYSTEM_DESCRIPTION=$(SYSTEM_DESCRIPTION)" YEAR=$(YEAR)

source: prepare
	$(MAKE) --makefile=$(SOURCE_MAKEFILE) PROJECT_NAME=$(PROJECT_NAME) BUILD_DIR=$(BUILD_DIR)/source PACKAGE_DIR=$(PACKAGE_DIR)/source DEBIAN_ARCHIVE=$(DEBIAN_ARCHIVE) SOURCE_FILES=$(SOURCE_FILES) CHANGES_FILE=$(SOURCE_CHANGES_FILE) SOURCE_ARCHIVE=$(SOURCE_ARCHIVE) DSC_FILE=$(DSC_FILE)

binary: prepare
	$(MAKE) --makefile=$(BINARY_MAKEFILE) DEBIAN_ARCHIVE=$(DEBIAN_ARCHIVE) SOURCE_ARCHIVE=$(SOURCE_ARCHIVE) BUILD_DIR=$(BUILD_DIR)/binary PACKAGE_DIR=$(PACKAGE_DIR)/binary DSC_FILE=$(DSC_FILE)

clean:
	$(MAKE) --makefile=$(PREPARE_MAKEFILE) PROJECT_NAME=$(PROJECT_NAME) BUILD_DIR=$(BUILD_DIR)/prepare DEBIAN_ARCHIVE=$(DEBIAN_ARCHIVE) SOURCE_DIR=$(SOURCE_DIR) SOURCE_FILES=$(SOURCE_FILES) "VERSION=$(VERSION)" DISTRIBUTION=$(DISTRIBUTION) SOURCE_ARCHIVE=$(SOURCE_ARCHIVE) clean
	$(MAKE) --makefile=$(SOURCE_MAKEFILE) PROJECT_NAME=$(PROJECT_NAME) BUILD_DIR=$(BUILD_DIR)/source PACKAGE_DIR=$(PACKAGE_DIR)/source DEBIAN_ARCHIVE=$(DEBIAN_ARCHIVE) SOURCE_FILES=$(SOURCE_FILES) CHANGES_FILE=$(SOURCE_CHANGES_FILE) SOURCE_ARCHIVE=$(SOURCE_ARCHIVE) clean
	$(MAKE) --makefile=$(BINARY_MAKEFILE) DEBIAN_ARCHIVE=$(DEBIAN_ARCHIVE) SOURCE_ARCHIVE=$(SOURCE_ARCHIVE) BUILD_DIR=$(BUILD_DIR)/binary PACKAGE_DIR=$(PACKAGE_DIR)/binary clean
	rm -rf $(BUILD_DIR)
	rm -rf $(PACKAGE_DIR)

list:
	@$(MAKE) -pRrq -f $(lastword $(MAKEFILE_LIST)) : 2>/dev/null | awk -v RS= -F: '/^# File/,/^# Finished Make data base/ {if ($$1 !~ "^[#.]") {print $$1}}' | sort | egrep -v -e '^[^[:alnum:]]' -e '^$@$$'

.PHONY: prepare source build clean all list
